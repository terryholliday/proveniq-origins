generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Chapter {
  id           String   @id @default(cuid())
  number       Int
  title        String
  summary      String   @default("")
  yearsCovered String   @default("[]")
  events       Event[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Person {
  id               String           @id @default(cuid())
  name             String
  role             String           @default("")
  relationshipType String           @default("")
  notes            String           @default("")
  isPrimary        Boolean          @default(false)
  eventLinks       EventPerson[]
  artifactLinks    ArtifactPerson[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model Song {
  id         String      @id @default(cuid())
  title      String
  artist     String
  era        String      @default("")
  keyLyric   String      @default("")
  notes      String      @default("")
  eventLinks EventSong[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model TraumaCycle {
  id          String   @id @default(cuid())
  label       String
  startYear   Int
  endYear     Int
  description String   @default("")
  events      Event[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Event {
  id                 String                 @id @default(cuid())
  title              String
  date               DateTime?
  location           String?
  summary            String?
  emotionTags        String                 @default("[]")
  notes              String?
  isKeystone         Boolean                @default(false)
  chapterId          String?
  traumaCycleId      String?
  chapter            Chapter?               @relation(fields: [chapterId], references: [id])
  traumaCycle        TraumaCycle?           @relation(fields: [traumaCycleId], references: [id])
  personLinks        EventPerson[]
  songLinks          EventSong[]
  artifactLinks      EventArtifact[]
  synchronicityLinks EventSynchronicity[]
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
}

model Artifact {
  id               String           @id @default(cuid())
  type             String
  sourceSystem     String           @default("")
  sourcePathOrUrl  String           @default("")
  shortDescription String           @default("")
  transcribedText  String?
  importedFrom     String?
  eventLinks       EventArtifact[]
  personLinks      ArtifactPerson[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model Synchronicity {
  id          String               @id @default(cuid())
  date        DateTime?
  type        String
  description String               @default("")
  symbolicTag String?
  eventLinks  EventSynchronicity[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

// ============================================
// EXPLICIT JOIN TABLES (Phase 2)
// ============================================

model EventPerson {
  id        String   @id @default(cuid())
  eventId   String
  personId  String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, personId])
}

model EventSong {
  id        String   @id @default(cuid())
  eventId   String
  songId    String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  song      Song     @relation(fields: [songId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, songId])
}

model EventArtifact {
  id         String   @id @default(cuid())
  eventId    String
  artifactId String
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([eventId, artifactId])
}

model EventSynchronicity {
  id              String        @id @default(cuid())
  eventId         String
  synchronicityId String
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  synchronicity   Synchronicity @relation(fields: [synchronicityId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([eventId, synchronicityId])
}

model ArtifactPerson {
  id         String   @id @default(cuid())
  artifactId String
  personId   String
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  person     Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([artifactId, personId])
}
