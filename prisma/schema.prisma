generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}


// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  googleId      String?  @unique
  passwordHash  String?
  name          String?
  picture       String?
  googleRefreshToken String?
  dropboxToken       String?
  aiConsent          Boolean  @default(false)
  
  // Relations
  chapters      Chapter[]
  persons       Person[]
  songs         Song[]
  traumaCycles  TraumaCycle[]
  events        Event[]
  artifacts     Artifact[]
  synchronicities Synchronicity[]
  tags          Tag[]
  collections   Collection[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Chapter {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  number       Int
  title        String
  summary      String   @default("")
  yearsCovered String   @default("[]")
  events       Event[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Person {
  id               String             @id @default(cuid())
  userId           String
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  role             String             @default("")
  relationshipType String             @default("")
  notes            String             @default("")
  isPrimary        Boolean            @default(false)
  tags             String             @default("[]")
  eventLinks       EventPerson[]
  artifactLinks    ArtifactPerson[]
  collectionLinks  CollectionPerson[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model Song {
  id         String      @id @default(cuid())
  userId     String
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title      String
  artist     String
  era        String      @default("")
  keyLyric   String      @default("")
  notes      String      @default("")
  eventLinks EventSong[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model TraumaCycle {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String
  startYear   Int
  endYear     Int
  description String   @default("")
  events      Event[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Event {
  id                 String                 @id @default(cuid())
  userId             String
  user               User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  title              String
  date               DateTime?
  time               String?                // HH:MM format for exact time (births, accidents, etc.)
  timeApproximate    Boolean                @default(false) // true if time is estimated
  location           String?
  summary            String?
  emotionTags        String                 @default("[]")
  notes              String?
  isKeystone         Boolean                @default(false)
  chapterId          String?
  traumaCycleId      String?
  chapter            Chapter?               @relation(fields: [chapterId], references: [id])
  traumaCycle        TraumaCycle?           @relation(fields: [traumaCycleId], references: [id])
  personLinks        EventPerson[]
  songLinks          EventSong[]
  artifactLinks      EventArtifact[]
  synchronicityLinks EventSynchronicity[]
  tagLinks           EventTag[]
  collectionLinks    CollectionEvent[]
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
}

model Artifact {
  id               String              @id @default(cuid())
  userId           String
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  type             String
  sourceSystem     String              @default("")
  sourcePathOrUrl  String              @default("")
  shortDescription String              @default("")
  transcribedText  String?
  importedFrom     String?
  eventLinks       EventArtifact[]
  personLinks      ArtifactPerson[]
  collectionLinks  CollectionArtifact[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model Synchronicity {
  id          String               @id @default(cuid())
  userId      String
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime?
  type        String
  description String               @default("")
  symbolicTag String?
  eventLinks  EventSynchronicity[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

// ============================================
// EXPLICIT JOIN TABLES (Phase 2)
// ============================================

model EventPerson {
  id        String   @id @default(cuid())
  eventId   String
  personId  String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, personId])
}

model EventSong {
  id        String   @id @default(cuid())
  eventId   String
  songId    String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  song      Song     @relation(fields: [songId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, songId])
}

model EventArtifact {
  id         String   @id @default(cuid())
  eventId    String
  artifactId String
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([eventId, artifactId])
}

model EventSynchronicity {
  id              String        @id @default(cuid())
  eventId         String
  synchronicityId String
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  synchronicity   Synchronicity @relation(fields: [synchronicityId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([eventId, synchronicityId])
}

model ArtifactPerson {
  id         String   @id @default(cuid())
  artifactId String
  personId   String
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  person     Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([artifactId, personId])
}

// ============================================
// PHASE 4 â€” TAGS & COLLECTIONS
// ============================================

model Tag {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String     @unique
  description String     @default("")
  eventLinks  EventTag[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Collection {
  id            String               @id @default(cuid())
  userId        String
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String               @default("")
  eventLinks    CollectionEvent[]
  artifactLinks CollectionArtifact[]
  personLinks   CollectionPerson[]
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

// Phase 4 Join Tables

model EventTag {
  id        String   @id @default(cuid())
  eventId   String
  tagId     String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, tagId])
}

model CollectionEvent {
  id           String     @id @default(cuid())
  collectionId String
  eventId      String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  event        Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([collectionId, eventId])
}

model CollectionArtifact {
  id           String     @id @default(cuid())
  collectionId String
  artifactId   String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  artifact     Artifact   @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([collectionId, artifactId])
}

model CollectionPerson {
  id           String     @id @default(cuid())
  collectionId String
  personId     String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  person       Person     @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([collectionId, personId])
}
